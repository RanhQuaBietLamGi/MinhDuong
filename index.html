<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Quản lý công việc Trello Style</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background: #f4f5f7; margin: 0; }
header { background: #026aa7; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
header h1 { font-size: 20px; }
#loginPanel, #adminPanel { margin: 10px; }
.board { display: flex; gap: 10px; padding: 10px; overflow-x: auto; }
.column { background: #ebecf0; border-radius: 5px; width: 300px; padding: 10px; flex-shrink: 0; }
.column h3 { margin-top: 0; }
.task { background: white; padding: 10px; border-radius: 3px; margin-bottom: 10px; box-shadow: 0 1px 0 rgba(9,30,66,.25); display: flex; justify-content: space-between; align-items: center; }
.task .actions { display: flex; gap: 5px; }
.task .comment-icon { color: #888; cursor: pointer; }
.task .comment-new { color: orange; }
.toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: #fff; padding: 8px 12px; border-radius: 6px; font-size: 14px; opacity: 0.9; }
#commentPopup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); display: none; width: 400px; max-height: 80%; overflow-y: auto; }
#commentList { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; margin-bottom: 10px; }
.comment { border-bottom: 1px solid #eee; padding: 4px 0; font-size: 14px; }
</style>
</head>
<body>

<header>
  <h1>Quản lý công việc</h1>
  <div>
    <span id="userStatus"></span>
    <button id="logoutBtn" style="display:none;">Đăng xuất</button>
  </div>
</header>

<div id="loginPanel">
  <input type="text" id="loginUsername" placeholder="Tên đăng nhập">
  <input type="password" id="loginPassword" placeholder="Mật khẩu">
  <button id="loginBtn">Đăng nhập</button>
</div>

<div id="adminPanel" style="display:none;">
  <h3>Tạo tài khoản mới (Admin)</h3>
  <input type="text" id="newUsername" placeholder="Tên đăng nhập mới">
  <input type="password" id="newPassword" placeholder="Mật khẩu ban đầu">
  <button id="createUserBtn">Tạo tài khoản</button>
</div>

<div class="board">
  <div class="column" id="todoColumn">
    <h3>Todo</h3>
    <div class="task-list" id="todoList"></div>
    <button id="addTodoTask">+ Thêm task</button>
  </div>
  <div class="column" id="processColumn">
    <h3>Process</h3>
    <div class="task-list" id="processList"></div>
  </div>
  <div class="column" id="doneColumn">
    <h3>Done</h3>
    <div class="task-list" id="doneList"></div>
  </div>
</div>

<div id="commentPopup">
  <h3>Bình luận</h3>
  <div id="commentList"></div>
  <input type="text" id="commentInput" placeholder="Viết bình luận...">
  <button id="sendCommentBtn">Gửi</button>
  <button onclick="closeCommentPopup()">Đóng</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCW49METqezYoUKSC1N0Pi3J83Ptsf9hA8",
  authDomain: "task-manager-d18aa.firebaseapp.com",
  projectId: "task-manager-d18aa",
  storageBucket: "task-manager-d18aa.firebasestorage.app",
  messagingSenderId: "1080268498085",
  appId: "1:1080268498085:web:767434c6a2c013b961d94c",
  measurementId: "G-FGGV4QX67R"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const ADMIN_EMAIL = "admin@myapp.com";
let currentUser = null;
let currentCommentTaskId = null;

document.getElementById('loginBtn').addEventListener('click', async () => {
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value.trim();
  if (!username || !password) return alert("Nhập đủ thông tin");
  const email = `${username}@myapp.com`;
  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch {
    alert("Sai thông tin đăng nhập");
  }
});

document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));

onAuthStateChanged(auth, user => {
  currentUser = user;
  if (user) {
    document.getElementById('userStatus').textContent = user.email;
    document.getElementById('logoutBtn').style.display = 'inline-block';
    document.getElementById('loginPanel').style.display = 'none';
    if (user.email === ADMIN_EMAIL) {
      document.getElementById('adminPanel').style.display = 'block';
    } else {
      document.getElementById('adminPanel').style.display = 'none';
    }
  } else {
    document.getElementById('userStatus').textContent = 'Khách';
    document.getElementById('logoutBtn').style.display = 'none';
    document.getElementById('loginPanel').style.display = 'block';
    document.getElementById('adminPanel').style.display = 'none';
  }
});

function renderTask(taskId, taskData, columnEl) {
  const div = document.createElement('div');
  div.className = 'task';
  div.innerHTML = `
    <span>${taskData.title}</span>
    <div class="actions">
      <i class="fa-solid fa-comment comment-icon" data-id="${taskId}"></i>
    </div>
  `;
  div.querySelector('.comment-icon').addEventListener('click', () => openCommentPopup(taskId));
  columnEl.appendChild(div);
}

function loadTasks() {
  onSnapshot(collection(db, "tasks"), snapshot => {
    document.getElementById('todoList').innerHTML = '';
    document.getElementById('processList').innerHTML = '';
    document.getElementById('doneList').innerHTML = '';
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      if (data.status === "todo") renderTask(docSnap.id, data, document.getElementById('todoList'));
      if (data.status === "process") renderTask(docSnap.id, data, document.getElementById('processList'));
      if (data.status === "done") renderTask(docSnap.id, data, document.getElementById('doneList'));
    });
  });
}
loadTasks();

function openCommentPopup(taskId) {
  currentCommentTaskId = taskId;
  document.getElementById('commentPopup').style.display = 'block';
  loadComments(taskId);
}

function closeCommentPopup() {
  document.getElementById('commentPopup').style.display = 'none';
}

async function loadComments(taskId) {
  const commentList = document.getElementById('commentList');
  commentList.innerHTML = '';
  onSnapshot(collection(db, "tasks", taskId, "comments"), snapshot => {
    commentList.innerHTML = '';
    snapshot.forEach(c => {
      const d = c.data();
      const div = document.createElement('div');
      div.className = 'comment';
      div.textContent = `${d.user}: ${d.text}`;
      commentList.appendChild(div);
    });
  });
}

document.getElementById('sendCommentBtn').addEventListener('click', async () => {
  if (!currentCommentTaskId) return;
  const text = document.getElementById('commentInput').value.trim();
  if (!text) return;
  await addDoc(collection(db, "tasks", currentCommentTaskId, "comments"), {
    user: currentUser ? currentUser.email : "Ẩn danh",
    text,
    createdAt: serverTimestamp()
  });
  document.getElementById('commentInput').value = '';
  showToast("Có bình luận mới");
});

function showToast(msg) {
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}
</script>
</body>
</html>

